{% extends 'base.html' %} {% block head %}
<title>TuneTagger</title>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/index.css') }}"
/>
<link
  href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap"
  rel="stylesheet"
/>
{% endblock %} {% block body %}

<div class="container">
  <h1 id="title">Welcome to TuneTagger!</h1>

  <h2>For music fans to organize their library by moods, not genres</h2>

  <div class="section">
    <h4>
      Would you like to add a song to your library?
      <span class="arrow">▼</span>
    </h4>

    <div class="content">
      <form action="{{url_for('post_request')}}" method="post" id="song-form">
        <label for="title-to-insert">Enter song title</label>
        <input type="text" name="title-to-insert" id="title-to-insert" />
        <label for="artist-to-insert">Enter artist</label>
        <input type="text" name="artist-to-insert" id="artist-to-insert" />
        <input type="submit" id="submit-insertion" value="Add song! :D" />
        <div id="checkmark" class="checkmark">&#10003;</div>
      </form>
    </div>
  </div>

  <div class="section">
    <h4>See your current library! <span class="arrow">▼</span></h4>

    <div class="content">
      <div class="filter-controls">
        <form
          action="{{ url_for('get_request')}}"
          method="GET"
          id="mood-filter-form"
        >
          <label for="mood=select"
            >Filter by Moods (Ctrl/Cmd Click to select multiple):</label
          >

          <select name="filter_moods" id="mood_select" multiple>
            <option value="">Show All Moods</option>
            {% for mood in available_moods %}
            <option
              value="{{ mood }}"
              {%
              if
              mood
              in
              selected_moods%}selected{%
              endif
              %}
            >
              {{ mood }}
            </option>
            {% endfor %}
          </select>

          <button type="submit">Apply filter</button>
        </form>
      </div>
      <div id="library-output" class="library-table">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Song Title</th>
              <th>Artist Name</th>
              <th>Mood</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for index, row in library_data.iterrows() %}
            <tr>
              <td>{{ row['#'] }}</td>
              <td>{{ row['Song Title'] }}</td>
              <td>{{ row['Artist Name'] }}</td>
              <td>{{ row['Mood'] }}</td>
              <td>
                <form method="POST" action="{{ url_for('post_request') }}">
                  <input
                    type="hidden"
                    name="id-to-delete"
                    value="{{ row['ID'] }}"
                  />
                  <button type="submit">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const libraryData = document.querySelector("#library-output").innerHTML;

    function toggleCollapsible(contentDiv, arrowElement = null) {
      if (!contentDiv) return;

      const isActive = contentDiv.classList.contains("active");
      contentDiv.style.transition =
        "max-height 0.5s ease, opacity 0.5s ease, padding 0.5s ease";

      if (!isActive) {
        expandElement(contentDiv, arrowElement);
      } else {
        collapseElement(contentDiv, arrowElement);
      }
    }

    function expandElement(element, arrowElement) {
      element.style.maxHeight = "";
      const naturalHeight = element.scrollHeight;
      element.style.maxHeight = "0px";
      element.style.opacity = "0";
      element.style.paddingTop = "0";
      element.style.paddingBottom = "0";
      element.offsetHeight;
      element.classList.add("active");
      element.style.maxHeight = naturalHeight + "px";
      element.style.opacity = "1";
      element.style.paddingTop = "20px";
      element.style.paddingBottom = "20px";
      if (arrowElement) arrowElement.textContent = "▲";
      const newHandler = function handler() {
        if (element.classList.contains("active")) {
          element.style.maxHeight = "none";
        }
        element.removeEventListener("transitionend", handler);
        delete element.dataset.transitionEndHandler;
      };
      element.addEventListener("transitionend", newHandler);
      element.dataset.transitionEndHandler = newHandler;
    }

    function collapseElement(element, arrowElement) {
      element.style.maxHeight = element.scrollHeight + "px";
      element.offsetHeight;
      element.classList.remove("active");
      element.style.maxHeight = "0px";
      element.style.opacity = "0";
      element.style.paddingTop = "0";
      element.style.paddingBottom = "0";
      if (arrowElement) arrowElement.textContent = "▼";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const headers = document.querySelectorAll(".section h4");
      headers.forEach((header) => {
        header.addEventListener("click", () => {
          const section = header.closest(".section");
          const content = section.querySelector(".content");
          const arrow = header.querySelector(".arrow");
          if (section.querySelector("#library-output")) {
            const wasOpen = content.classList.contains("active");
            toggleCollapsible(content, arrow);
            if (wasOpen) {
              sessionStorage.setItem("openLibrary", "0");
            } else {
              sessionStorage.setItem("openLibrary", "1");
            }
          } else {
            toggleCollapsible(content, arrow);
          }
        });
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("song-form");
      const checkmark = document.getElementById("checkmark");

      if (form) {
        form.addEventListener("submit", function () {
          sessionStorage.setItem("showCheckmark", "1");
          sessionStorage.setItem("openSection", "add-song");
        });
      }

      if (sessionStorage.getItem("showCheckmark") === "1") {
        sessionStorage.removeItem("showCheckmark");
        if (checkmark) {
          checkmark.classList.add("visible");
          setTimeout(() => {
            checkmark.classList.remove("visible");
          }, 1500);
        }
      }

      if (sessionStorage.getItem("openSection") === "add-song") {
        sessionStorage.removeItem("openSection");
        const addSongContent = document.querySelectorAll(".content")[0];
        const addSongArrow = document.querySelectorAll(".section .arrow")[0];
        if (addSongContent) {
          expandElement(addSongContent, addSongArrow);
        }
      }
    });
  </script>

  {% endblock %}
</div>
