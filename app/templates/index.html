{% extends 'base.html' %} {% block body %}
<div class="container">
  <h1 id="title">Welcome to TuneTagger!</h1>

  <h2>For music fans to organize their library by moods, not genres</h2>

  <div class="section">
    <h4>
      Would you like to add a song to your library?
      <span class="arrow">▼</span>
    </h4>

    <div class="content">
      <form action="/api/add-song" method="post" id="song-form">
        <label for="title-to-insert">Enter song title</label>
        <input type="text" name="title-to-insert" id="title-to-insert" />
        <label for="artist-to-insert">Enter artist</label>
        <input type="text" name="artist-to-insert" id="artist-to-insert" />
        <input type="submit" id="submit-insertion" value="Add song! :D" />
        <div id="checkmark" class="checkmark">&#10003;</div>
      </form>
    </div>
  </div>

  <div class="section">
    <h4>See your current library! <span class="arrow">▼</span></h4>

    <div class="content">
      <div class="filter-controls">
        <form action="{{ url_for('index')}}" method="GET" id="mood-filter-form">
          <label for="mood=select"
            >Filter by Moods (Ctrl/Cmd Click to select multiple):</label
          >

          <select name="filter_moods" id="mood_select" multiple>
            {% for mood in available_moods %}
            <option
              value="{{ mood }}"
              {%
              if
              mood
              in
              selected_moods%}selected{%
              endif
              %}
            >
              {{ mood }}
            </option>
            {% endfor %}
          </select>

          <button type="submit" id="filter-apply">Apply filter</button>
        </form>
      </div>
      <div id="library-output" class="library-table">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Song Title</th>
              <th>Artist Name</th>
              <th>Mood</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for index, row in library_data.iterrows() %}
            <tr>
              <td>{{ row['#'] }}</td>
              <td>{{ row['Song Title'] }}</td>
              <td>{{ row['Artist Name'] }}</td>
              <td>{{ row['Mood'] }}</td>
              <td>
                <form
                  method="POST"
                  action="/api/delete-song"
                  class="delete-form"
                >
                  <input
                    type="hidden"
                    name="id-to-delete"
                    value="{{ row['ID'] }}"
                  />
                  <button type="submit">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const libraryData = document.querySelector("#library-output").innerHTML;

    function toggleCollapsible(contentDiv, arrowElement = null) {
      if (!contentDiv) return;

      const isActive = contentDiv.classList.contains("active");
      contentDiv.style.transition =
        "max-height 0.5s ease, opacity 0.5s ease, padding 0.5s ease";

      if (!isActive) {
        expandElement(contentDiv, arrowElement);
      } else {
        collapseElement(contentDiv, arrowElement);
      }
    }

    function expandElement(element, arrowElement) {
      element.style.maxHeight = "";
      const naturalHeight = element.scrollHeight;
      element.style.maxHeight = "0px";
      element.style.opacity = "0";
      element.style.paddingTop = "0";
      element.style.paddingBottom = "0";
      element.offsetHeight;
      element.classList.add("active");
      element.style.maxHeight = naturalHeight + "px";
      element.style.opacity = "1";
      element.style.paddingTop = "20px";
      element.style.paddingBottom = "20px";
      if (arrowElement) arrowElement.textContent = "▲";
      const newHandler = function handler() {
        if (element.classList.contains("active")) {
          element.style.maxHeight = "none";
        }
        element.removeEventListener("transitionend", handler);
        delete element.dataset.transitionEndHandler;
      };
      element.addEventListener("transitionend", newHandler);
      element.dataset.transitionEndHandler = newHandler;
    }

    function collapseElement(element, arrowElement) {
      element.style.maxHeight = element.scrollHeight + "px";
      element.offsetHeight;
      element.classList.remove("active");
      element.style.maxHeight = "0px";
      element.style.opacity = "0";
      element.style.paddingTop = "0";
      element.style.paddingBottom = "0";
      if (arrowElement) arrowElement.textContent = "▼";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const headers = document.querySelectorAll(".section h4");
      headers.forEach((header) => {
        header.addEventListener("click", () => {
          const section = header.closest(".section");
          const content = section.querySelector(".content");
          const arrow = header.querySelector(".arrow");
          if (section.querySelector("#library-output")) {
            const wasOpen = content.classList.contains("active");
            toggleCollapsible(content, arrow);
            if (wasOpen) {
              sessionStorage.setItem("openLibrary", "0");
            } else {
              sessionStorage.setItem("openLibrary", "1");
            }
          } else {
            toggleCollapsible(content, arrow);
          }
        });
      });
    });
  </script>

  <script>
    // Function to update the mood filter dropdown
    function updateMoodFilter(availableMoods, selectedMoods = []) {
      const moodSelect = document.getElementById("mood_select");
      if (!moodSelect) return;

      moodSelect.innerHTML = availableMoods
        .map(
          (mood) =>
            `<option value="${mood}" ${
              selectedMoods.includes(mood) ? "selected" : ""
            }>${mood}</option>`
        )
        .join("");
    }

    // Function to update the library table with new data
    function updateLibraryTable(libraryData) {
      const tbody = document.querySelector("#library-output table tbody");
      if (!tbody) return;

      tbody.innerHTML = libraryData
        .map(
          (song) => `
        <tr>
          <td>${song.num}</td>
          <td>${song.title}</td>
          <td>${song.artist}</td>
          <td>${song.mood}</td>
          <td>
            <form method="POST" class="delete-form" data-id="${song.id}">
              <input type="hidden" name="id-to-delete" value="${song.id}" />
              <button type="submit">Delete</button>
            </form>
          </td>
        </tr>
      `
        )
        .join("");

      // Re-attach delete handlers to new forms
      attachDeleteHandlers();
    }

    // Function to handle delete form submissions via AJAX
    function attachDeleteHandlers() {
      document
        .querySelectorAll(".delete-form, #library-output form[method='POST']")
        .forEach((form) => {
          // Remove existing listeners by cloning
          const newForm = form.cloneNode(true);
          form.parentNode.replaceChild(newForm, form);

          newForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const button = this.querySelector("button");
            const originalText = button.textContent;

            button.textContent = "...";
            button.disabled = true;

            try {
              const response = await fetch("/api/delete-song", {
                method: "POST",
                body: formData,
              });

              const data = await response.json();

              if (data.success) {
                updateLibraryTable(data.library);
                // Update the mood filter dropdown
                if (data.availableMoods) {
                  updateMoodFilter(data.availableMoods);
                }
              } else {
                alert(data.error || "Failed to delete song");
                button.textContent = originalText;
                button.disabled = false;
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred while deleting the song");
              button.textContent = originalText;
              button.disabled = false;
            }
          });
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("song-form");
      const checkmark = document.getElementById("checkmark");

      // Handle add song form via AJAX
      if (form) {
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const submitBtn = document.getElementById("submit-insertion");
          const originalValue = submitBtn.value;

          submitBtn.value = "Adding...";
          submitBtn.disabled = true;

          try {
            const response = await fetch("/api/add-song", {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            if (data.success) {
              // Update the library table
              updateLibraryTable(data.library);

              // Update the mood filter dropdown
              if (data.availableMoods) {
                updateMoodFilter(data.availableMoods);
              }

              // Show checkmark
              if (checkmark) {
                checkmark.classList.add("visible");
                setTimeout(() => {
                  checkmark.classList.remove("visible");
                }, 1500);
              }

              // Clear the form
              form.reset();
            } else {
              alert(data.error || "Failed to add song");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while adding the song");
          } finally {
            submitBtn.value = originalValue;
            submitBtn.disabled = false;
          }
        });
      }

      // Attach delete handlers to existing forms
      attachDeleteHandlers();

      // Handle mood filter form via AJAX
      const filterForm = document.getElementById("mood-filter-form");
      if (filterForm) {
        filterForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          const selectedMoods = Array.from(
            document.getElementById("mood_select").selectedOptions
          ).map((opt) => opt.value);

          const params = new URLSearchParams();
          selectedMoods.forEach((mood) => params.append("filter_moods", mood));

          const filterBtn = document.getElementById("filter-apply");
          const originalText = filterBtn.textContent;
          filterBtn.textContent = "Filtering...";
          filterBtn.disabled = true;

          try {
            const response = await fetch(
              `/api/filter-songs?${params.toString()}`
            );
            const data = await response.json();

            if (data.success) {
              updateLibraryTable(data.library);
            } else {
              alert(data.error || "Failed to filter songs");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while filtering");
          } finally {
            filterBtn.textContent = originalText;
            filterBtn.disabled = false;
          }
        });
      }

      // Restore library open state
      if (sessionStorage.getItem("openLibrary") === "1") {
        const libraryContent = document.querySelectorAll(".content")[1];
        const libraryArrow = document.querySelectorAll(".section .arrow")[1];
        if (libraryContent) {
          expandElement(libraryContent, libraryArrow);
        }
      }
    });
  </script>

  {% endblock %}
</div>
